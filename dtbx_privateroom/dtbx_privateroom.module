<?php

/**
 * init().
 */

  
function dtbx_privateroom_init() {

static $already_added = FALSE;

  if ($already_added) {
    return; // Don't add the JavaScript and CSS multiple times.
  }	
  // Include the CTools tools that we need.
  ctools_include('ajax');
  ctools_include('modal');

  // Add CTools' javascript to the page.
  ctools_modal_add_js();
  
  $path = drupal_get_path('module', 'dtbx_privateroom');
  drupal_add_js($path . '/js/dtbx_privateroom.js', array('weight' => -20));
  
  $already_added = TRUE;
}

/**
 * Implements hook_menu().
 */
 
function dtbx_privateroom_menu() 
{


    $items['dtbx_privateroom'] = array(
        'title' => 'Личные данные',
        'access callback' => 'dtbx_privateroom_access',
        'page callback' => 'dtbx_privateroom_callback',
		'page arguments' => array(1),		
        'type' => MENU_CALLBACK,
    );
	return $items;
}
/**
* Page callback.
**/

function dtbx_privateroom_callback($ajax) 
{
  if ($ajax) {
    
    $form_state = array(
      'ajax' => TRUE,
      'title' => t('Личный кабинет')
    );

    $output = ctools_modal_form_wrapper('dtbx_privateroom_page', $form_state);

    if (!empty($form_state['ajax_commands'])) {
      $output = $form_state['ajax_commands'];
    }
	
    print ajax_render($output);
  }
  else {
	drupal_set_message('sl_3', 'status');  
    return drupal_get_form('dtbx_privateroom_page');
  }	
}

function dtbx_privateroom_page($form, &$form_state) 
{

	$surname = "";
	$firstname = "";
	$patronname = "";
	$companyname = "";
	$juraddress = "";
	$realaddress = "";
	$contact = "";
	$persondata = "Персональные данные";
	$change_psw = "Смена пароля";
	$load_pl = "Разместить прайс-лист";
	
	
	
	global $user;
	$items = db_query('select * from T_USER where uid = :uid', array(':uid' => $user->uid))->fetchObject();;
	
	if(count($items) > 0)
	{
		$surname = $items->USER_SURNAME;
		$firstname = $items->USER_NAME;
		$patronname = $items->USER_PATRONYMIC;
		$companyname = $items->COMPANY_NAME;
		$juraddress = $items->COMPANY_ADDRESS;
		$realaddress = $items->COMPANY_ACTUAL_ADDRESS;
		$contact = $items->COMPANY_CONTACT;
		//$persondata .= $items->USER_LOGIN;
	}
  
  $form['#attributes'] = array('class' => 'ctools-use-modal');
  
  $form['vertical_tabs'] = array(
    '#type' => 'vertical_tabs',
	'#title' => $items->USER_LOGIN, 
  ); 

  $form['access'] = array(
    '#type' => 'fieldset', 
    '#title' => t($persondata), 
    '#tree' => TRUE,
	'#group' => 'vertical_tabs'
  );  
  
  $form['access']['surname'] = array(
    '#type' => 'textfield', 
	'#title' => t('Фамилия'), 
    '#default_value' => $surname, 
    '#size' => 60, 
    '#maxlength' => 128
  );
  
  $form['access']['firstname'] = array(
    '#type' => 'textfield', 
    '#title' => t('Имя'), 
    '#default_value' => $firstname, 
    '#size' => 60, 
    '#maxlength' => 128
  );
  
  $form['access']['patronname'] = array(
    '#type' => 'textfield', 
    '#title' => t('Отчество'), 
    '#default_value' => $patronname, 
    '#size' => 60, 
    '#maxlength' => 128
  );
  
  $form['access']['companyname'] = array(
    '#type' => 'textfield', 
    '#title' => t('Наименование компании'), 
    '#default_value' => $companyname, 
    '#size' => 60, 
    '#maxlength' => 128
  );
  
  $form['access']['juraddress'] = array(
    '#type' => 'textfield', 
    '#title' => t('Юридический адрес'), 
    '#default_value' => $juraddress, 
    '#size' => 60, 
    '#maxlength' => 128
  );
  
  $form['access']['realaddress'] = array(
    '#type' => 'textfield', 
    '#title' => t('Фактический  адрес'), 
    '#default_value' => $realaddress, 
    '#size' => 60, 
    '#maxlength' => 128
  );
  
  $form['access']['contact'] = array(
    '#type' => 'textfield', 
    '#title' => t('Контактное лицо'), 
    '#default_value' => $contact, 
    '#size' => 60, 
    '#maxlength' => 128
  );

  $form['access']['submit'] = array(
    '#type' => 'submit', 
    '#value' => t('Изменить'), 
    '#submit' => array('dtbx_privateroom_submit')
  );

  $form['change_psw'] = array(
    '#type' => 'fieldset', 
    '#title' => t($change_psw), 
    '#tree' => TRUE,
	'#group' => 'vertical_tabs'	
  );  
  
  $form['load_pl'] = array(
    '#type' => 'fieldset', 
    '#title' => t($load_pl), 
    '#tree' => TRUE,
	'#group' => 'vertical_tabs'	
  );  
  
  return $form;
}


/**
* Page access.
**/

function dtbx_privateroom_access() {
  global $user;
  return ($user->uid > 0);

}

function dtbx_privateroom_submit($form, &$form_state)
{
	global $user;
   
	db_query('UPDATE T_USER u 
		      SET u.USER_SURNAME = :USER_SURNAME, 
				  u.USER_NAME = :USER_NAME, 
				  u.USER_PATRONYMIC = :USER_PATRONYMIC, 
				  u.COMPANY_NAME = :COMPANY_NAME, 
				  u.COMPANY_ADDRESS = :COMPANY_ADDRESS, 
				  u.COMPANY_ACTUAL_ADDRESS = :COMPANY_ACTUAL_ADDRESS, 
				  u.COMPANY_CONTACT = :COMPANY_CONTACT 
              WHERE u.UID = :UID', 
		   array(':USER_SURNAME' => $form_state['values']['access']['surname'],
				 ':USER_NAME' => $form_state['values']['access']['firstname'],
				 ':USER_PATRONYMIC' => $form_state['values']['access']['patronname'],
				 ':COMPANY_NAME' => $form_state['values']['access']['companyname'],
				 ':COMPANY_ADDRESS' => $form_state['values']['access']['juraddress'],
				 ':COMPANY_ACTUAL_ADDRESS' => $form_state['values']['access']['realaddress'],
				 ':COMPANY_CONTACT' =>  $form_state['values']['access']['contact'],
				 ':UID' => $user->uid
		   ));

return $form;
}


?>
